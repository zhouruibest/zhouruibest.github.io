- 在线业务体系 通常服务于终端用户，包含 Web 服务，算法服务，有状态服务，视频编解码、FaaS 服务等，这些服务通常对 RPC 调用延迟比较敏感，对实时性要求高。
- 离线业务体系 包含临时查询、定时报表、模型训练、数据分析等作业，这些服务的特点是它们可以承受一定程度的排队或等待，在合理时间得到合理结果即可。

对于大部分的在线服务来说，业务的访问量具备明显波峰波谷的潮汐变化。

为了保证在线业务在高峰时段的稳定性，在业务部署时，业务方必须按照峰时的流量来预估申请资源，这部分资源在谷时就会被闲置下来，造成严重的资源浪费。

而 Kubernetes 原生就提供了 HPA 的概念，可以根据 workload 的实际资源使用情况来扩缩无状态服务的实例数。如果我们可以通过弹性伸缩，在业务处于低谷时，通过回收业务副本数的方式来回收这部分资源，然后在业务处于峰值时，重新恢复业务的副本数，那么我们就能够在保证服务的 SLA 几乎不受影响的前提下，回收大量在线低谷时段的弹性资源。

# 弹性伸缩
大部分的在线服务都属于无状态服务，可以直接通过水平扩展来增加副本数。

## HPA/VPA
## Keda

# 在线离线混部
在开启了大规模弹性伸缩后，在线业务就具备了和离线作业进行混合部署的能力。

![](./根据集群水位变化进行混部.awebp)

初始情况下，在线服务没有进行弹性伸缩，集群中整体的资源部署处于满载状态。当在线服务的波谷来临后，几乎所有服务都会因为弹性缩容而导致副本数降低。从整体上看，集群里节点上的 Pod 会变得非常稀疏，集群整体资源部署水位也随之降低。
当集群的部署水位低于设置的阈值后，控制面会通过一定规则选取部分在线节点，**将该节点上的 Pod 驱逐到别的节点上，并标记该节点不可调度，最后将离线服务调度到该节点上实现资源的出借**。
同理，当在线服务的波峰来临后，会发生一个逆向的控制过程，控制面在通知并确保离线任务撤离后，重新将节点设置为在线可调度状态，实现资源的回收。在实际操作中，集群的水位阈值通常会定义在 90% 的水平上，这就意味着集群在常态下会始终维持在一个接近满载的部署状态中，从而能够最大限度地提升资源利用率。
分时弹性混部的控制面最主要的职责就是控制节点的动态出让和回收，即节点的动态伸缩。可以用一个状态机来描述节点的转移状态，其中 Online 和 Offline 分别表示节点处于在线使用和离线使用的状态。而当节点被选择进行出让和回收时，会分别先进入到 OnlineToOffline 或 OfflineToOnline 的中间状态。在此状态下在离线都无法调度新的任务到节点上来，控制面会负责清理残留的在线的 Pod 和离线任务，并执行用户所配置的 hook 函数，只有当这些工作都处理完成后，才会真正完成节点的出让和回收逻辑。

# 离线资源的不稳定问题

弹性资源最大的特点是它整体的资源供应量不确定，当在线服务出现抖动时，我们需要优先保证在线服务的稳定性，极端情况下需要通过杀死离线业务来为在线服务腾挪资源。而离线任务通常运行的时间长，频繁杀死和重跑任务对离线业务来说也会造成较大的影响。因此如何在不稳定的资源供应基础上保证离线业务的稳定性也十分重要。

资源不稳定性主要来自以下两个方面：
1. 弹性资源的供应量是不稳定的。弹性资源的供应量受制于在线业务的扩缩容情况，这会导致整体的资源的总量、资源供应的时间，甚至每一天资源所对应的具体的机器环境是不一样的。因此我们没有办法让离线业务针对弹性资源做一些提前的资源规划，同时当在线业务发生任何抖动时，我们会随时进行资源回收，这对整个训练作业的体验并不好。
2. 弹性资源的需求量是不稳定的。离线作业存在 min/max 语义，例如在一个 PS-Worker 离线训练中，Worker 的数量其实是不确定的，离线业务整体的资源描述也并非确定值。同时我们还需要解决一个问题，即在提高单个作业的训练速度和满足更多训练作业之寻求平衡。

那么在抖音集团内部，研发团队如何解决上述问题？

1. 在资源供应方面：我们在执行缩容操作的过程中，引入了 deletion cost 机制定义实例缩容的优先级。比如我们可以尽可能地缩容整机，甚至尽可能地保证这些缩容出来的资源处于同一个 Pod 或者使用了同质的 GPU ，从而**减少资源碎片的问题**。
2. 在资源分配方面：对于一些离线业务例如离线训练来说，因为作业在调度和非调度的过程中，可能会执行很多次 checkpoint dump 和 reload 操作，这个操作过程需要从 HDFS 上实现完整模型的上传和下载，非常耗时。如果我们运行更多的作业，虽然在一定程度上可以优化用户的体验，但是弹性资源在归还给在线业务时会触发多次无效的 checkpoint 操作占据大量时间，从而降低资源的利用效率。因此对于离线训练业务，我们更倾向于提高单个作业的加速比，而不是运行更多的作业。
2. 在资源回收方面：**为了解决资源回收的过程中无脑地杀死离线业务的问题，研发团队构建了弹性资源的优先级，基于优先级实现资源回收**。目前的弹性资源大概分为三级，如下图所示。以 PS-Worker 架构的离线分布式训练为例，PS 作业可能会处于一个 High 的优先级；能够满足基本运行的 Min 的 Worker 处于中优的优先级；为了进行弹性加测的 Worker 处于 low 的优先级。这样做的好处是当我们在线进行资源回收时，我们可以定制一些调度器的抢占策略，**使得在线服务总是倾向于去抢占低优先级的作业资源**。
3. 除此之外，我们在分时弹性混部的控制面引入**提前通知的机制**，在提前通知的时间窗口内，不会再调度新的离线任务，同时尽可能保证那些已经被调度的任务顺利跑完，从而将任务杀死率维持在一个可接受的范围内。

