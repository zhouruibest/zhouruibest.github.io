`#define` 指令 定义的名字的作用域从其定义点开始，到被编译的源文件的末尾处结束。宏定义中也可以使用前面出现的宏定义。

# 带参数的宏

宏定义也可以带参数，这样可以对不同的宏调用使用不同的替换文本。例如:
```c
#define max(A, B) ((A) > (B) ? (A) : (B))
```

使用宏 max 看起来很像是函数词用，但宏调用直接将替换文本插入到代码中。形式参数(在
此为 A 或 B)的每次出现都将被替换成对应的实际参数。因此，语句: `x = max(p+q, r+s);`将被替换为:`x = ((p+q) > (r+s) ? (p+q) : (r+s));`

# undef指令

可以通过`#undef`指令取消名字的宏定义，这样做可以保证后续的调用是函数调用，而不是宏调用.

# 带#的宏指令

形式参数不能用带引号的字符串替换。但是，如果在替换文本中，参数名以#作为前缀则 结果将被扩展为由实际参数替换该参数的带引号的字符串。例如，可以将它与字符串连接运算结合起来编写一个调试打印宏:
```c
#define dprint(expr) printf(#expr " = %g\n", expr)
```

使用语句
```c
dprint(x/y)
```
调用该宏时，该宏将被扩展为:
```c
printf("x/y" " = &g\n", x/y);
```
其中的字符串被连接起来了，这样，该宏调用的效果等价于
```c
printf("x/y = &g\n", x/y);
```
在实际参数中，每个双引号"将被替换为\"，反斜杠\将被替换为\\，因此替换后的字符串是合法的字符串常量。

# 使用宏拼接

预处理器运算符`##`为宏扩展提供了一种连接实际参数的手段。如果替换文本中的参数与`##`相邻，则该参数将被实际参数替换，`##`与前后的空白符将被删除，并对替换后的结果重新扫描。例如，下面定义的宏 paste 用于连接两个参数
```c #define paste(front, back) front ## back``` 因此，宏调用`paste(name, 1)`的结果将建立记号`name1`

`##` 的嵌套使用规则比较难以掌握. TODO

# 条件包含
```c
#if !defined(HDR)
#define HDR
/* hdr.h 文件的内容放在这里 */
#endif
```

第一次包含头文件 hdr.h 时，将定义名字 HDR;此后再次包含该头文件时，会发现该名字已 经定义，这样将直接跳转到#endif 处。类似的方式也可以用来避免多次重复包含同一文件。 如果多个头文件能够一致地使用这种方式，那么，每个头文件都可以将它所依赖的任何头文 件包含进来，用户不必考虑和处理头文件之间的各种依赖关系。

下面的这段预处理代码首先测试系统变量`SYSTEM`，然后根据该变量的值确定包含哪个版本的头文件:
```c
#if SYSTEM == SYSV #define HDR "sysv.h"
#elif SYSTEM == BSD #define HDR "bsd.h"
#elif SYSTEM == MSDOS #define HDR "msdos.h"
#else
#define HDR "default.h"
   #endif
   #include HDR
```

C 语言专门定义了两个预处理语句`#ifdef`与`#ifndef`，它们用来测试某个名字是否已经 定义。上面有关#if 的第一个例子可以改写为下列形式:
```c
#ifndef HDR
#define EDR
/* hdr.h 文件的内容放在这里 */
#endif
```

# 技巧

如果宏里有多过一个语句（statement），就需要用 `do { /*...*/ } while(0)` 包裹成单个语句，否则会有如下的问题：
```c
#define M() a(); b()    // 定义宏
if (cond)
    M();                // 使用宏
else
    c();
```
预处理后

```c
if (cond)
    a(); b(); /* b(); 在 if 之外     */
else          /* <- else 缺乏对应 if */
    c();
```
只用 { } 也不行：
```c
#define M() { a(); b(); }
```
预处理后
```c
if (cond)
    { a(); b(); }; /* 最后的分号代表 if 语句结束 */
else               /* else 缺乏对应 if */
    c();
```
用 `do while` 就行了：

```c
#define M() do { a(); b(); } while(0)
```
预处理后
```c
if (cond)
    do { a(); b(); } while(0);
else
    c();
```